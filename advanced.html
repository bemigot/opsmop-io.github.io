

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Language Part 2 &mdash; OpsMop  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="OpsMop Module Index" href="modules/modules.html" />
    <link rel="prev" title="Language" href="language.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="contents.html" class="icon icon-home"> OpsMop
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Intro</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="local.html">Using Local Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="language.html">Language</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Language</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#provider-selection">Provider Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variable-scoping">Variable Scoping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eval">Eval</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conditions">Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nested-scopes">Nested Scopes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#registration">Registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tags">Tags</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ignore-errors">Ignore Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#change-reporting-control">Change Reporting Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#failure-status-overrides">Failure Status Overrides</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hooks">Hooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules/modules.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="facts.html">Facts</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="pull.html">Pull Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="push.html">Push/Orchestration Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="contents.html">OpsMop</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="contents.html">Docs</a> &raquo;</li>
        
      <li>Language Part 2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/advanced.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <img alt="OpsMop Logo" src="_images/opsmop.png" />
<div class="section" id="language-part-2">
<span id="advanced"></span><h1>Language Part 2<a class="headerlink" href="#language-part-2" title="Permalink to this headline">¶</a></h1>
<p>Once you have covered the basics of the language in <a class="reference internal" href="language.html#language"><span class="std std-ref">Language</span></a>, there are many more
additional language features you may be interested in.</p>
<p>We say these are ‘advanced’ features not because they are complicated, but just because they
are optional.  These are the features that you should learn second, or maybe third, after
trying out a few modules.</p>
<p>Many simple configurations in OpsMop may simply use modules like
<a class="reference internal" href="modules/module_service.html#module-service"><span class="std std-ref">Service Module</span></a>, <a class="reference internal" href="modules/module_package.html#module-package"><span class="std std-ref">Package Module</span></a>, and <a class="reference internal" href="modules/module_file.html#module-file"><span class="std std-ref">File Module</span></a>, and
will not need all of these features, but it is also likely that every OpsMop
configuration will want to use at least some of the features explained below.</p>
<p>OpsMop encourages random-access learning.</p>
<p>The language examples below will refer to many modules detailed further in the <a class="reference internal" href="modules/modules.html#modules"><span class="std std-ref">OpsMop Module Index</span></a> section, so
feel free to jump back and forth. The best way to understand these features is to consult
the <a class="reference external" href="https://github.com/opsmop/opsmop-demo">opsmop-demo</a> repo on GitHub, and also as you
read through <a class="reference internal" href="modules/modules.html#modules"><span class="std std-ref">OpsMop Module Index</span></a>, you will see some of these features used in the examples in context.</p>
<p>Many of the examples are contrived and don’t deploy real applications, but are constructed to teach
lessons about things such as <a class="reference internal" href="#var-scoping"><span class="std std-ref">Variable Scoping</span></a> or <a class="reference internal" href="#conditionals"><span class="std std-ref">Conditions</span></a>.  Real OpsMop policies
for deploying an application stack would be a bit longer and would use a larger mixture of modules in concert.</p>
<p>By studying these arbitrary examples though, you can quickly experiment and try to put
them together in your own <a class="reference internal" href="language.html#policy"><span class="std std-ref">Policy</span></a> configurations.</p>
<p>OpsMop does not believe you should need an extremely large library of example configurations, we want you to learn
the tool and be able to easily construct your own.</p>
<div class="section" id="provider-selection">
<span id="method"></span><h2>Provider Selection<a class="headerlink" href="#provider-selection" title="Permalink to this headline">¶</a></h2>
<p>We’ve discussed Types a bit already.</p>
<p>When we talk about things like “File()”, “Service()”, or “Package()” in OpsMop, we call them resources,
but really resources come in two parts - Types and Providers.</p>
<p>Often, <a class="reference internal" href="language.html#types"><span class="std std-ref">Types</span></a> may be coded to return only one provider.  Other modules may choose a default based
on the operating sysstem. As an example, the File() resource has only one implementation but there will be
many different implementations for Package().</p>
<p>Providers are the implementation code that make system changes as expressed in a Type.  The Type just defines
the request.</p>
<p>To install a package using the default <em>Provider</em>, we don’t have to do anything special:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Package</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cowsay&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>However, the default type is not always the one you will want to use.  For instance, the default
Package provider on Ubuntu would be “apt”, and on CentOS 7 it would be “yum”, but what if we wanted
to install a package from Python’s pip?</p>
<p>To specify or force a specific provider:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Package</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pygments&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pip&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>NOTE that at this point in OpsMop’s development, we have a lot of providers to add for packages yet.
This makes a great point of contribution, so if you are interested, see the <a class="reference internal" href="community.html#community"><span class="std std-ref">Community</span></a> section.</p>
<p>Ok, so that’s how to pick a stock provider.</p>
<p>It’s also possible to use a provider that OpsMop doesn’t ship with, perhaps one that you wrote for
some of your own internal services:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Package</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cowsay&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;your.custom.provider.spork&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Expressing that full path for the provider name is verbose (and subject to typos), so it helps to save those strings to a python constant
to improve readability.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Package</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cowsay&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">SPORK</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="variable-scoping">
<span id="var-scoping"></span><h2>Variable Scoping<a class="headerlink" href="#variable-scoping" title="Permalink to this headline">¶</a></h2>
<p>OpsMop uses variables in both templates and conditionals.</p>
<p>We’ve already talked a little bit about variables, and knowledge of variables weighs in on
future sections and nearly everything in OpsMop.</p>
<p>It is important to not confuse Python variables with OpsMop variables.  To transfer a Python class variable
or global variable into OpsMop template space, use <a class="reference internal" href="modules/module_set.html#module-set"><span class="std std-ref">Set Module</span></a>.</p>
<p>OpsMop has a very simple to understand variable system based on the
concept of scope.  Variables defined at outer scopes are always available further
down, but changing a variable inside a scope does not effect the value at the outer scope.
These variables are ‘scope-local’.</p>
<p>In the opsmop-demo repository, <a class="reference external" href="https://github.com/opsmop/opsmop-demo/blob/master/content/var_scoping.py">var_scoping.py</a> demonstrates
the various variable scopes in OpsMop.</p>
<p>Because this is a long example, we’ll refer you to GitHub and ask you to read and perhaps run the example. In browsing
the source, you will understand more about what is possible with variable scopes.</p>
</div>
<div class="section" id="eval">
<span id="id1"></span><h2>Eval<a class="headerlink" href="#eval" title="Permalink to this headline">¶</a></h2>
<p>Similar to T(), a computation of two variables is doable with Eval:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Set</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">Echo</span><span class="p">(</span><span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;a + b&quot;</span><span class="p">))</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The difference with Eval() vs “T()” is that Eval can return native python types, whereas T() always
returns a string.  Here is a contrived example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Set</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">Set</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">Eval</span><span class="p">(</span><span class="s1">&#39;a+b&#39;</span><span class="p">)),</span>
        <span class="n">Debug</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>In the above example, ‘c’ would be set to the number 5, not the string “5” (or worse, the string “23”)</p>
<p>Where would you use this directly? Probably not very often.</p>
<p>Eval is used to implement <a class="reference internal" href="#conditionals"><span class="std std-ref">Conditions</span></a>, described below.</p>
</div>
<div class="section" id="conditions">
<span id="conditionals"></span><h2>Conditions<a class="headerlink" href="#conditions" title="Permalink to this headline">¶</a></h2>
<p>Any role, policy, or resource can be given a conditional.  If the conditional is true, that object
will be skipped during the check or apply phase.</p>
<p>Expressions are specified with “when=”, and accept valid <a class="reference external" href="http://jinja.pocoo.org/docs/">Jinja2</a> expressions.  This is technically
implemented using <a class="reference internal" href="#eval"><span class="std std-ref">Eval</span></a> but leaving off Eval is provided as syntactic sugar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;reboot&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;a &gt; b&quot;</span><span class="p">)</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<p>This is the same as the overly redundant:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;reboot&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;a &gt; b&quot;</span><span class="p">))</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<p>And while it serves no purpose that couldn’t be achieved with a comment, technically this also disables
a resource:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;reboot&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Development info: Both Eval() and T() are implementations of the class “Lookup”, and you can write your own
subclasses of Lookup if you wish to write any kind of runtime lookup into an external system.
See <a class="reference internal" href="development.html#development"><span class="std std-ref">Development Guide</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python developers will be interested to know you can save common conditions to package or class variables, including
Eval expressions.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Referencing an undefined variable in a condition will intentionally result in an error. This may be avoided
by using <a class="reference external" href="http://jinja.pocoo.org/docs/">Jinja2</a> to select defaults. However, you could also just define a default with <a class="reference internal" href="modules/module_set.html#module-set"><span class="std std-ref">Set Module</span></a>
prior to doing a ‘register’ call (see <a class="reference internal" href="#registration"><span class="std std-ref">Registration</span></a>) and make things easy. That way, all variables will have defaults
and you don’t have to express the default from within a template.  This tip also works for general templating
advice.</p>
</div>
</div>
<div class="section" id="nested-scopes">
<span id="id3"></span><h2>Nested Scopes<a class="headerlink" href="#nested-scopes" title="Permalink to this headline">¶</a></h2>
<p>Resources in OpsMop can be nested, to attach variables at different scopes.  This is best demoed by
<a class="reference external" href="https://github.com/opsmop/opsmop-demo/blob/master/content/var_scoping.py">var_scoping.py</a> which is a very
arbitrary demo but shows how it is done.</p>
</div>
<div class="section" id="registration">
<span id="id5"></span><h2>Registration<a class="headerlink" href="#registration" title="Permalink to this headline">¶</a></h2>
<p>The value of one command can easily be saved and fed into the output of another.</p>
<p>This value is entered into local scope:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
    <span class="n">resources</span><span class="o">.</span><span class="n">add</span><span class="p">([</span>
        <span class="n">Shell</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">),</span>
        <span class="n">Debug</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">),</span>
        <span class="n">Echo</span><span class="p">(</span><span class="s2">&quot;{{ date.rc }}&quot;</span><span class="p">),</span>
        <span class="n">Echo</span><span class="p">(</span><span class="s2">&quot;{{ date.data }}&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">resources</span>
</pre></div>
</div>
<p>Registration works well with coupled with <a class="reference internal" href="#conditionals"><span class="std std-ref">Conditions</span></a>, <a class="reference internal" href="#failed-when"><span class="std std-ref">Failure Status Overrides</span></a> and <a class="reference internal" href="#changed-when"><span class="std std-ref">Change Reporting Control</span></a>.
Some of these examples are shown in the ‘opsmop-demo’ repo.</p>
</div>
<div class="section" id="tags">
<span id="id6"></span><h2>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h2>
<p>OpsMop Tags are a feature where any certain resources in OpsMop can be selectively triggered without running all
of the other resources in the policy file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DemoPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">set_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">Roles</span><span class="p">(</span>
            <span class="n">Security</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;security&#39;</span><span class="p">]),</span>
            <span class="n">WebServer</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;webserver&#39;</span><span class="p">])</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>In the above example, if the opsmop binary was invoked with “--tags=security”, only the security role
would be processed.</p>
<p>The special tag name ‘any’ triggers regardless of what is specified with ‘--tags’.</p>
<p>Tags can be assigned to any resource or collection and automatically apply to all contained resources.
This is best demonstrated by the <a class="reference external" href="https://github.com/opsmop/opsmop-demo/blob/master/content/basics.py">tags.py</a> demo in the <a class="reference external" href="https://github.com/opsmop/opsmop-demo">opsmop-demo</a> repo.</p>
</div>
<div class="section" id="ignore-errors">
<span id="id8"></span><h2>Ignore Errors<a class="headerlink" href="#ignore-errors" title="Permalink to this headline">¶</a></h2>
<p>Most commands will intentionally stop the execution of an OpsMop policy upon hitting an error. A common
example would be Shell() return codes. This is avoidable, and quite useful in combination with the register
command.  This is demoed in the <a class="reference internal" href="modules/module_shell.html#module-shell"><span class="std std-ref">Shell Module</span></a> documentation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Resources</span><span class="p">(</span>
        <span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;ls foo | wc -l&quot;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s2">&quot;line_count&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Echo</span><span class="p">(</span><span class="s2">&quot;line_count.data&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="change-reporting-control">
<span id="changed-when"></span><h2>Change Reporting Control<a class="headerlink" href="#change-reporting-control" title="Permalink to this headline">¶</a></h2>
<p>Normally, a resource will mark itself as containing changes if it performs any actions to the system.
Presence of these changes are used to decide whether to notify <a class="reference internal" href="language.html#handlers"><span class="std std-ref">Handlers</span></a>.</p>
<p>Sometimes, particularly for shell commands, this is not appropriate, and the changed status
should possibly depend on specific return codes or output. The state can be overriden as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;/bin/foo --args&quot;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">changed_when</span><span class="o">=</span><span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;&#39;changed&#39; in x.data&quot;</span><span class="p">),</span> <span class="n">notify</span><span class="o">=</span><span class="s2">&quot;some_step&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If not using handlers, the change reporting isn’t too significant, but is still useful to record whether or not
the policy evaluation made any changes.</p>
<p>If no ‘changed_when’ clause is added to the Shell resource, it will always record that it made a change.</p>
</div>
<div class="section" id="failure-status-overrides">
<span id="failed-when"></span><h2>Failure Status Overrides<a class="headerlink" href="#failure-status-overrides" title="Permalink to this headline">¶</a></h2>
<p>By default, if a resource returns a fatal error, the program will halt at that point. What causes an error like this?
Errors could be a non-zero exit code from the <span class="xref std std-ref">shell</span> module, or any other time a provider might return a failed result that is not
a runtime exception.</p>
<p>The problem is, sometimes return codes are not reliable.  Other times, return codes are not enough.</p>
<p>Here are a few examples of controlling when a resource should be considered failed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;/bin/foo --args&quot;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">failed_when</span><span class="o">=</span><span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;x.rc != 5&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;/bin/foo --args&quot;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">failed_when</span><span class="o">=</span><span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;x.rc != 0 or not &#39;SUCCESS&#39; in x.data&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>It may also be clearer to save that conditional string to a class or
package variable and use it this way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SUCCESS_IN_OUTPUT</span> <span class="o">=</span> <span class="n">Eval</span><span class="p">(</span><span class="s2">&quot;x.rc != 0 or not &#39;SUCCESS&#39; in x.data&quot;</span><span class="p">)</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">Shell</span><span class="p">(</span><span class="s2">&quot;/bin/foo --args&quot;</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">failed_when</span><span class="o">=</span><span class="n">SUCCESS_IN_OUTPUT</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<div class="section" id="hooks">
<span id="id9"></span><h2>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h2>
<p>Every single object in the OpsMop language may define some special methods. These are most useful on <em>Roles</em> and <em>Policies</em>
but can also be used on any <em>Type</em> instance if you subclass the Type.</p>
<div class="section" id="post">
<span id="hooks-post"></span><h3>post()<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h3>
<p>This method is called after a resource is evaluated.</p>
<p>This is demoed in <a class="reference external" href="https://github.com/opsmop/opsmop-demo/blob/master/content/user_facts.py">user_facts.py</a> to
demonstrate invalidating the facts cache (see <a class="reference internal" href="facts.html#facts"><span class="std std-ref">Facts</span></a>) in between role executions.</p>
<p>Both pre and post can do literally anything you want.</p>
<p>The return values are ignored.</p>
</div>
<div class="section" id="pre">
<span id="hooks-pre"></span><h3>pre()<a class="headerlink" href="#pre" title="Permalink to this headline">¶</a></h3>
<p>The opposite of post().</p>
<p>A pre method would be called prior to evaluating a role in either check or apply mode.</p>
<p>The most trivial use of pre might be to print a quick message when entering a role, without relying on <a class="reference internal" href="modules/module_echo.html#module-echo"><span class="std std-ref">Echo Module</span></a>.</p>
</div>
<div class="section" id="should-execute-when">
<span id="hooks-should-execute-when"></span><h3>should_execute_when()<a class="headerlink" href="#should-execute-when" title="Permalink to this headline">¶</a></h3>
<p>This is powerful. This method is called to decide whether a resource should be executed at all.</p>
<p>In the example <cite>user_facts.py &lt;https://github.com/opsmop/opsmop-demo/blob/master/content/user_facts.py&gt;</cite>
we cleverly use should_execute_when() to implement feature flags - a given <em>Role</em> skips entirely when a fact is not set.
This is also an easy way to make a role that only runs on a certain platform.  Thus OS specific parts of a multi-OS deployment
can be split up into different roles, while still retaining common roles in other parts.</p>
<p>(See also <a class="reference internal" href="facts.html#facts"><span class="std std-ref">Facts</span></a>).</p>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="modules/modules.html#modules"><span class="std std-ref">OpsMop Module Index</span></a></li>
<li><a class="reference internal" href="facts.html#facts"><span class="std std-ref">Facts</span></a></li>
<li><a class="reference internal" href="development.html#development"><span class="std std-ref">Development Guide</span></a></li>
<li><a class="reference internal" href="api.html#api"><span class="std std-ref">API</span></a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="modules/modules.html" class="btn btn-neutral float-right" title="OpsMop Module Index" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="language.html" class="btn btn-neutral" title="Language" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michael DeHaan LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
  <style>
    .wy-side-nav-search, .wy-nav-top {
      background: #444444;
    }
    .wy-nav-side {
      background: #444444;
    }
  </style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127828570-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-127828570-1');
</script>



</body>
</html>